# 消息系统

# 基础概念

- AMQP：AMQP 是一种开放的 Internet 协议，用于可靠地发送和接收消息。

- MOM：面向消息的中间件是一种方法，是一种分布式系统的体系结构，即整个分布式系统的中间层，其中存在大量内部通信（一个组件正在查询数据，然后需要将其发送给另一个 组件，它将对数据进行一些处理），因此组件必须在它们之间共享信息/数据。

- Message Broker 消息代理：是在 MOM 中处理消息（发送和接收）的任何系统，或更确切地说，是将消息路由到特定使用者/收件人的任何系统。消息代理通常基于 MOM 构建。MOM 提供了应用程序之间的基本通信，以及诸如消息持久性和保证的传递之类的东西。“消息代理是面向消息的中间件的构建块。”

# 消息传递模型

分布式消息系统支持流和队列两种语义，这两种语义最适合使用的场景有所不同。在面向微服务或事件驱动的体系结构中，队列模型和流模型都是必需的。

## 队列（Queue）模型

在队列消息系统中，一个队列可能有多个 producer 和 consumer。producer 向队列发送消息，consumer 从队列中接收消息。接收消息后，consumer 开始处理消息，并在处理完每条消息后向队列消息系统发送 ack。由于多个 consumer 共用一个队列，消息顺序并不重要，因此基于队列的系统很容易对 consumer 进行扩展。消息队列系统适用于不需要按特定顺序执行任务的队列，例如，发送同一封邮件给多个收件人。RabbitMQ 和 Amazon SQS 都是基于队列的消息系统。

队列模型主要是采用无序或者共享的方式来消费消息。通过队列模型，用户可以创建多个消费者从单个管道中接收消息；当一条消息从队列发送出来后，多个消费者中的只有一个（任何一个都有可能）接收和消费这条消息。消息系统的具体实现决定了最终哪个消费者实际接收到消息。

队列模型通常与无状态应用程序一起结合使用。无状态应用程序不关心排序，但它们确实需要能够确认（ack）或删除单条消息，以及尽可能地扩展消费并行性的能力。典型的基于队列模型的消息系统包括 RabbitMQ 和 RocketMQ。

## 流式（Stream）模型

在流消息系统中，producer 追加数据到“仅追加”消息流中。在每个消息流中，必须按特定顺序处理消息，consumer 在消息流中标记消息的位置。我们可以采取某种策略（如对用户 ID 进行哈希处理）对消息进行分区，使分区成为单独的数据流，增加并行度。由于每个流中的数据不可变，且只保存偏移 entry，因此处理时不会遗漏消息。流适用于重视消息顺序（如提取数据）的场景。Kafka 和 Amazon Kinesis 都使用流语义处理消息。

相比之下，流模型要求消息的消费严格排序或独占消息消费。对于一个管道，使用流式模型，始终只会有一个消费者使用和消费消息。消费者按照消息写入管道的确切顺序接收从管道发送的消息。

流模型通常与有状态应用程序相关联。有状态的应用程序更加关注消息的顺序及其状态。消息的消费顺序决定了有状态应用程序的状态。消息的顺序将影响应用程序处理逻辑的正确性。